#include "SpectralMapper.h"
#include <set>

float SpectralMapper::CIE_X[CIEWavelengthSize] = {
    3.769647e-03f, 4.532416e-03f, 5.446553e-03f, 6.538868e-03f,
    7.839699e-03f, 9.382967e-03f, 1.120608e-02f, 1.334965e-02f,
    1.585690e-02f, 1.877286e-02f, 2.214302e-02f, 2.601285e-02f,
    3.043036e-02f, 3.544325e-02f, 4.109640e-02f, 4.742986e-02f,
    5.447394e-02f, 6.223612e-02f, 7.070048e-02f, 7.982513e-02f,
    8.953803e-02f, 9.974848e-02f, 1.104019e-01f, 1.214566e-01f,
    1.328741e-01f, 1.446214e-01f, 1.566468e-01f, 1.687901e-01f,
    1.808328e-01f, 1.925216e-01f, 2.035729e-01f, 2.137531e-01f,
    2.231348e-01f, 2.319245e-01f, 2.403892e-01f, 2.488523e-01f,
    2.575896e-01f, 2.664991e-01f, 2.753532e-01f, 2.838921e-01f,
    2.918246e-01f, 2.989200e-01f, 3.052993e-01f, 3.112031e-01f,
    3.169047e-01f, 3.227087e-01f, 3.288194e-01f, 3.349242e-01f,
    3.405452e-01f, 3.451688e-01f, 3.482554e-01f, 3.494153e-01f,
    3.489075e-01f, 3.471746e-01f, 3.446705e-01f, 3.418483e-01f,
    3.390240e-01f, 3.359926e-01f, 3.324276e-01f, 3.280157e-01f,
    3.224637e-01f, 3.156225e-01f, 3.078201e-01f, 2.994771e-01f,
    2.909776e-01f, 2.826646e-01f, 2.747962e-01f, 2.674312e-01f,
    2.605847e-01f, 2.542749e-01f, 2.485254e-01f, 2.433039e-01f,
    2.383414e-01f, 2.333253e-01f, 2.279619e-01f, 2.219781e-01f,
    2.151735e-01f, 2.075619e-01f, 1.992183e-01f, 1.902290e-01f,
    1.806905e-01f, 1.707154e-01f, 1.604471e-01f, 1.500244e-01f,
    1.395705e-01f, 1.291920e-01f, 1.189859e-01f, 1.090615e-01f,
    9.951424e-02f, 9.041850e-02f, 8.182895e-02f, 7.376817e-02f,
    6.619477e-02f, 5.906380e-02f, 5.234242e-02f, 4.600865e-02f,
    4.006154e-02f, 3.454373e-02f, 2.949091e-02f, 2.492140e-02f,
    2.083981e-02f, 1.723591e-02f, 1.407924e-02f, 1.134516e-02f,
    9.019658e-03f, 7.097731e-03f, 5.571145e-03f, 4.394566e-03f,
    3.516303e-03f, 2.887638e-03f, 2.461588e-03f, 2.206348e-03f,
    2.149559e-03f, 2.337091e-03f, 2.818931e-03f, 3.649178e-03f,
    4.891359e-03f, 6.629364e-03f, 8.942902e-03f, 1.190224e-02f,
    1.556989e-02f, 1.997668e-02f, 2.504698e-02f, 3.067530e-02f,
    3.674999e-02f, 4.315171e-02f, 4.978584e-02f, 5.668554e-02f,
    6.391651e-02f, 7.154352e-02f, 7.962917e-02f, 8.821473e-02f,
    9.726978e-02f, 1.067504e-01f, 1.166192e-01f, 1.268468e-01f,
    1.374060e-01f, 1.482471e-01f, 1.593076e-01f, 1.705181e-01f,
    1.818026e-01f, 1.931090e-01f, 2.045085e-01f, 2.161166e-01f,
    2.280650e-01f, 2.405015e-01f, 2.535441e-01f, 2.671300e-01f,
    2.811351e-01f, 2.954164e-01f, 3.098117e-01f, 3.241678e-01f,
    3.384319e-01f, 3.525786e-01f, 3.665839e-01f, 3.804244e-01f,
    3.940988e-01f, 4.076972e-01f, 4.213484e-01f, 4.352003e-01f,
    4.494206e-01f, 4.641616e-01f, 4.794395e-01f, 4.952180e-01f,
    5.114395e-01f, 5.280233e-01f, 5.448696e-01f, 5.618898e-01f,
    5.790137e-01f, 5.961882e-01f, 6.133784e-01f, 6.305897e-01f,
    6.479223e-01f, 6.654866e-01f, 6.833782e-01f, 7.016774e-01f,
    7.204110e-01f, 7.394495e-01f, 7.586285e-01f, 7.777885e-01f,
    7.967750e-01f, 8.154530e-01f, 8.337389e-01f, 8.515493e-01f,
    8.687862e-01f, 8.853376e-01f, 9.011588e-01f, 9.165278e-01f,
    9.318245e-01f, 9.474524e-01f, 9.638388e-01f, 9.812596e-01f,
    9.992953e-01f, 1.017343e+00f, 1.034790e+00f, 1.051011e+00f,
    1.065522e+00f, 1.078421e+00f, 1.089944e+00f, 1.100320e+00f,
    1.109767e+00f, 1.118438e+00f, 1.126266e+00f, 1.133138e+00f,
    1.138952e+00f, 1.143620e+00f, 1.147095e+00f, 1.149464e+00f,
    1.150838e+00f, 1.151326e+00f, 1.151033e+00f, 1.150002e+00f,
    1.148061e+00f, 1.144998e+00f, 1.140622e+00f, 1.134757e+00f,
    1.127298e+00f, 1.118342e+00f, 1.108033e+00f, 1.096515e+00f,
    1.083928e+00f, 1.070387e+00f, 1.055934e+00f, 1.040592e+00f,
    1.024385e+00f, 1.007344e+00f, 9.895268e-01f, 9.711213e-01f,
    9.523257e-01f, 9.333248e-01f, 9.142877e-01f, 8.952798e-01f,
    8.760157e-01f, 8.561607e-01f, 8.354235e-01f, 8.135565e-01f,
    7.904565e-01f, 7.664364e-01f, 7.418777e-01f, 7.171219e-01f,
    6.924717e-01f, 6.681600e-01f, 6.442697e-01f, 6.208450e-01f,
    5.979243e-01f, 5.755410e-01f, 5.537296e-01f, 5.325412e-01f,
    5.120218e-01f, 4.922070e-01f, 4.731224e-01f, 4.547417e-01f,
    4.368719e-01f, 4.193121e-01f, 4.018980e-01f, 3.844986e-01f,
    3.670592e-01f, 3.497167e-01f, 3.326305e-01f, 3.159341e-01f,
    2.997374e-01f, 2.841189e-01f, 2.691053e-01f, 2.547077e-01f,
    2.409319e-01f, 2.277792e-01f, 2.152431e-01f, 2.033010e-01f,
    1.919276e-01f, 1.810987e-01f, 1.707914e-01f, 1.609842e-01f,
    1.516577e-01f, 1.427936e-01f, 1.343737e-01f, 1.263808e-01f,
    1.187979e-01f, 1.116088e-01f, 1.047975e-01f, 9.834835e-02f,
    9.224597e-02f, 8.647506e-02f, 8.101986e-02f, 7.586514e-02f,
    7.099633e-02f, 6.639960e-02f, 6.206225e-02f, 5.797409e-02f,
    5.412533e-02f, 5.050600e-02f, 4.710606e-02f, 4.391411e-02f,
    4.091411e-02f, 3.809067e-02f, 3.543034e-02f, 3.292138e-02f,
    3.055672e-02f, 2.834146e-02f, 2.628033e-02f, 2.437465e-02f,
    2.262306e-02f, 2.101935e-02f, 1.954647e-02f, 1.818727e-02f,
    1.692727e-02f, 1.575417e-02f, 1.465854e-02f, 1.363571e-02f,
    1.268205e-02f, 1.179394e-02f, 1.096778e-02f, 1.019964e-02f,
    9.484317e-03f, 8.816851e-03f, 8.192921e-03f, 7.608750e-03f,
    7.061391e-03f, 6.549509e-03f, 6.071970e-03f, 5.627476e-03f,
    5.214608e-03f, 4.831848e-03f, 4.477579e-03f, 4.150166e-03f,
    3.847988e-03f, 3.569452e-03f, 3.312857e-03f, 3.076022e-03f,
    2.856894e-03f, 2.653681e-03f, 2.464821e-03f, 2.289060e-03f,
    2.125694e-03f, 1.974121e-03f, 1.833723e-03f, 1.703876e-03f,
    1.583904e-03f, 1.472939e-03f, 1.370151e-03f, 1.274803e-03f,
    1.186238e-03f, 1.103871e-03f, 1.027194e-03f, 9.557493e-04f,
    8.891262e-04f, 8.269535e-04f, 7.689351e-04f, 7.149425e-04f,
    6.648590e-04f, 6.185421e-04f, 5.758303e-04f, 5.365046e-04f,
    5.001842e-04f, 4.665005e-04f, 4.351386e-04f, 4.058303e-04f,
    3.783733e-04f, 3.526892e-04f, 3.287199e-04f, 3.063998e-04f,
    2.856577e-04f, 2.664108e-04f, 2.485462e-04f, 2.319529e-04f,
    2.165300e-04f, 2.021853e-04f, 1.888338e-04f, 1.763935e-04f,
    1.647895e-04f, 1.539542e-04f, 1.438270e-04f, 1.343572e-04f,
    1.255141e-04f, 1.172706e-04f, 1.095983e-04f, 1.024685e-04f,
    9.584715e-05f, 8.968316e-05f, 8.392734e-05f, 7.853708e-05f,
    7.347551e-05f, 6.871576e-05f, 6.425257e-05f, 6.008292e-05f,
    5.620098e-05f, 5.259870e-05f, 4.926279e-05f, 4.616623e-05f,
    4.328212e-05f, 4.058715e-05f, 3.806114e-05f, 3.568818e-05f,
    3.346023e-05f, 3.137090e-05f, 2.941371e-05f, 2.758222e-05f,
    2.586951e-05f, 2.426701e-05f, 2.276639e-05f, 2.136009e-05f,
    2.004122e-05f, 1.880380e-05f, 1.764358e-05f, 1.655671e-05f,
    1.553939e-05f, 1.458792e-05f, 1.369853e-05f, 1.286705e-05f,
    1.208947e-05f, 1.136207e-05f, 1.068141e-05f, 1.004411e-05f,
    9.446399e-06f, 8.884754e-06f, 8.356050e-06f, 7.857521e-06f,
    7.386996e-06f, 6.943576e-06f, 6.526548e-06f, 6.135087e-06f,
    5.768284e-06f, 5.425069e-06f, 5.103974e-06f, 4.803525e-06f,
    4.522350e-06f, 4.259166e-06f, 4.012715e-06f, 3.781597e-06f,
    3.564496e-06f, 3.360236e-06f, 3.167765e-06f, 2.986206e-06f,
    2.814999e-06f, 2.653663e-06f, 2.501725e-06f, 2.358723e-06f,
    2.224206e-06f, 2.097737e-06f, 1.978894e-06f, 1.867268e-06f,
    1.762465e-06f
};

float SpectralMapper::CIE_Y[CIEWavelengthSize] = {
    4.146161e-04f, 5.028333e-04f, 6.084991e-04f, 7.344436e-04f,
    8.837389e-04f, 1.059646e-03f, 1.265532e-03f, 1.504753e-03f,
    1.780493e-03f, 2.095572e-03f, 2.452194e-03f, 2.852216e-03f,
    3.299115e-03f, 3.797466e-03f, 4.352768e-03f, 4.971717e-03f,
    5.661014e-03f, 6.421615e-03f, 7.250312e-03f, 8.140173e-03f,
    9.079860e-03f, 1.005608e-02f, 1.106456e-02f, 1.210522e-02f,
    1.318014e-02f, 1.429377e-02f, 1.545004e-02f, 1.664093e-02f,
    1.785302e-02f, 1.907018e-02f, 2.027369e-02f, 2.144805e-02f,
    2.260041e-02f, 2.374789e-02f, 2.491247e-02f, 2.612106e-02f,
    2.739923e-02f, 2.874993e-02f, 3.016909e-02f, 3.165145e-02f,
    3.319038e-02f, 3.477912e-02f, 3.641495e-02f, 3.809569e-02f,
    3.981843e-02f, 4.157940e-02f, 4.337098e-02f, 4.517180e-02f,
    4.695420e-02f, 4.868718e-02f, 5.033657e-02f, 5.187611e-02f,
    5.332218e-02f, 5.470603e-02f, 5.606335e-02f, 5.743393e-02f,
    5.885107e-02f, 6.030809e-02f, 6.178644e-02f, 6.326570e-02f,
    6.472352e-02f, 6.614749e-02f, 6.757256e-02f, 6.904928e-02f,
    7.063280e-02f, 7.238339e-02f, 7.435960e-02f, 7.659383e-02f,
    7.911436e-02f, 8.195345e-02f, 8.514816e-02f, 8.872657e-02f,
    9.266008e-02f, 9.689723e-02f, 1.013746e-01f, 1.060145e-01f,
    1.107377e-01f, 1.155111e-01f, 1.203122e-01f, 1.251161e-01f,
    1.298957e-01f, 1.346299e-01f, 1.393309e-01f, 1.440235e-01f,
    1.487372e-01f, 1.535066e-01f, 1.583644e-01f, 1.633199e-01f,
    1.683761e-01f, 1.735365e-01f, 1.788048e-01f, 1.841819e-01f,
    1.896559e-01f, 1.952101e-01f, 2.008259e-01f, 2.064828e-01f,
    2.121826e-01f, 2.180279e-01f, 2.241586e-01f, 2.307302e-01f,
    2.379160e-01f, 2.458706e-01f, 2.546023e-01f, 2.640760e-01f,
    2.742490e-01f, 2.850680e-01f, 2.964837e-01f, 3.085010e-01f,
    3.211393e-01f, 3.344175e-01f, 3.483536e-01f, 3.629601e-01f,
    3.782275e-01f, 3.941359e-01f, 4.106582e-01f, 4.277595e-01f,
    4.453993e-01f, 4.635396e-01f, 4.821376e-01f, 5.011430e-01f,
    5.204972e-01f, 5.401387e-01f, 5.600208e-01f, 5.800972e-01f,
    6.003172e-01f, 6.206256e-01f, 6.409398e-01f, 6.610772e-01f,
    6.808134e-01f, 6.999044e-01f, 7.180890e-01f, 7.351593e-01f,
    7.511821e-01f, 7.663143e-01f, 7.807352e-01f, 7.946448e-01f,
    8.082074e-01f, 8.213817e-01f, 8.340701e-01f, 8.461711e-01f,
    8.575799e-01f, 8.682408e-01f, 8.783061e-01f, 8.879907e-01f,
    8.975211e-01f, 9.071347e-01f, 9.169947e-01f, 9.269295e-01f,
    9.366731e-01f, 9.459482e-01f, 9.544675e-01f, 9.619834e-01f,
    9.684390e-01f, 9.738289e-01f, 9.781519e-01f, 9.814106e-01f,
    9.836669e-01f, 9.852081e-01f, 9.863813e-01f, 9.875357e-01f,
    9.890228e-01f, 9.910811e-01f, 9.934913e-01f, 9.959172e-01f,
    9.980205e-01f, 9.994608e-01f, 9.999930e-01f, 9.997557e-01f,
    9.989839e-01f, 9.979123e-01f, 9.967737e-01f, 9.957356e-01f,
    9.947115e-01f, 9.935534e-01f, 9.921156e-01f, 9.902549e-01f,
    9.878596e-01f, 9.849324e-01f, 9.815036e-01f, 9.776035e-01f,
    9.732611e-01f, 9.684764e-01f, 9.631369e-01f, 9.571062e-01f,
    9.502540e-01f, 9.424569e-01f, 9.336897e-01f, 9.242893e-01f,
    9.146707e-01f, 9.052333e-01f, 8.963613e-01f, 8.883069e-01f,
    8.808462e-01f, 8.736445e-01f, 8.663755e-01f, 8.587203e-01f,
    8.504295e-01f, 8.415047e-01f, 8.320109e-01f, 8.220154e-01f,
    8.115868e-01f, 8.007874e-01f, 7.896515e-01f, 7.782053e-01f,
    7.664733e-01f, 7.544785e-01f, 7.422473e-01f, 7.298229e-01f,
    7.172525e-01f, 7.045818e-01f, 6.918553e-01f, 6.791009e-01f,
    6.662846e-01f, 6.533595e-01f, 6.402807e-01f, 6.270066e-01f,
    6.135148e-01f, 5.998494e-01f, 5.860682e-01f, 5.722261e-01f,
    5.583746e-01f, 5.445535e-01f, 5.307673e-01f, 5.170130e-01f,
    5.032889e-01f, 4.895950e-01f, 4.759442e-01f, 4.623958e-01f,
    4.490154e-01f, 4.358622e-01f, 4.229897e-01f, 4.104152e-01f,
    3.980356e-01f, 3.857300e-01f, 3.733907e-01f, 3.609245e-01f,
    3.482860e-01f, 3.355702e-01f, 3.228963e-01f, 3.103704e-01f,
    2.980865e-01f, 2.861160e-01f, 2.744822e-01f, 2.631953e-01f,
    2.522628e-01f, 2.416902e-01f, 2.314809e-01f, 2.216378e-01f,
    2.121622e-01f, 2.030542e-01f, 1.943124e-01f, 1.859227e-01f,
    1.778274e-01f, 1.699654e-01f, 1.622841e-01f, 1.547397e-01f,
    1.473081e-01f, 1.400169e-01f, 1.329013e-01f, 1.259913e-01f,
    1.193120e-01f, 1.128820e-01f, 1.067113e-01f, 1.008052e-01f,
    9.516653e-02f, 8.979594e-02f, 8.469044e-02f, 7.984009e-02f,
    7.523372e-02f, 7.086061e-02f, 6.671045e-02f, 6.277360e-02f,
    5.904179e-02f, 5.550703e-02f, 5.216139e-02f, 4.899699e-02f,
    4.600578e-02f, 4.317885e-02f, 4.050755e-02f, 3.798376e-02f,
    3.559982e-02f, 3.334856e-02f, 3.122332e-02f, 2.921780e-02f,
    2.732601e-02f, 2.554223e-02f, 2.386121e-02f, 2.227859e-02f,
    2.079020e-02f, 1.939185e-02f, 1.807939e-02f, 1.684817e-02f,
    1.569188e-02f, 1.460446e-02f, 1.358062e-02f, 1.261573e-02f,
    1.170696e-02f, 1.085608e-02f, 1.006476e-02f, 9.333376e-03f,
    8.661284e-03f, 8.046048e-03f, 7.481130e-03f, 6.959987e-03f,
    6.477070e-03f, 6.027677e-03f, 5.608169e-03f, 5.216691e-03f,
    4.851785e-03f, 4.512008e-03f, 4.195941e-03f, 3.902057e-03f,
    3.628371e-03f, 3.373005e-03f, 3.134315e-03f, 2.910864e-03f,
    2.701528e-03f, 2.505796e-03f, 2.323231e-03f, 2.153333e-03f,
    1.995557e-03f, 1.849316e-03f, 1.713976e-03f, 1.588899e-03f,
    1.473453e-03f, 1.367022e-03f, 1.268954e-03f, 1.178421e-03f,
    1.094644e-03f, 1.016943e-03f, 9.447269e-04f, 8.775171e-04f,
    8.150438e-04f, 7.570755e-04f, 7.033755e-04f, 6.537050e-04f,
    6.078048e-04f, 5.653435e-04f, 5.260046e-04f, 4.895061e-04f,
    4.555970e-04f, 4.240548e-04f, 3.946860e-04f, 3.673178e-04f,
    3.417941e-04f, 3.179738e-04f, 2.957441e-04f, 2.750558e-04f,
    2.558640e-04f, 2.381142e-04f, 2.217445e-04f, 2.066711e-04f,
    1.927474e-04f, 1.798315e-04f, 1.678023e-04f, 1.565566e-04f,
    1.460168e-04f, 1.361535e-04f, 1.269451e-04f, 1.183671e-04f,
    1.103928e-04f, 1.029908e-04f, 9.611836e-05f, 8.973323e-05f,
    8.379694e-05f, 7.827442e-05f, 7.313312e-05f, 6.834142e-05f,
    6.387035e-05f, 5.969389e-05f, 5.578862e-05f, 5.213509e-05f,
    4.872179e-05f, 4.553845e-05f, 4.257443e-05f, 3.981884e-05f,
    3.725877e-05f, 3.487467e-05f, 3.264765e-05f, 3.056140e-05f,
    2.860175e-05f, 2.675841e-05f, 2.502943e-05f, 2.341373e-05f,
    2.190914e-05f, 2.051259e-05f, 1.921902e-05f, 1.801796e-05f,
    1.689899e-05f, 1.585309e-05f, 1.487243e-05f, 1.395085e-05f,
    1.308528e-05f, 1.227327e-05f, 1.151233e-05f, 1.080001e-05f,
    1.013364e-05f, 9.509919e-06f, 8.925630e-06f, 8.377852e-06f,
    7.863920e-06f, 7.381539e-06f, 6.929096e-06f, 6.505136e-06f,
    6.108221e-06f, 5.736935e-06f, 5.389831e-06f, 5.065269e-06f,
    4.761667e-06f, 4.477561e-06f, 4.211597e-06f, 3.962457e-06f,
    3.728674e-06f, 3.508881e-06f, 3.301868e-06f, 3.106561e-06f,
    2.922119e-06f, 2.748208e-06f, 2.584560e-06f, 2.430867e-06f,
    2.286786e-06f, 2.151905e-06f, 2.025656e-06f, 1.907464e-06f,
    1.796794e-06f, 1.693147e-06f, 1.596032e-06f, 1.504903e-06f,
    1.419245e-06f, 1.338600e-06f, 1.262556e-06f, 1.190771e-06f,
    1.123031e-06f, 1.059151e-06f, 9.989507e-07f, 9.422514e-07f,
    8.888804e-07f, 8.386690e-07f, 7.914539e-07f, 7.470770e-07f,
    7.053860e-07f
};

float SpectralMapper::CIE_Z[CIEWavelengthSize] = {
    1.847260e-02f, 2.221101e-02f, 2.669819e-02f, 3.206937e-02f,
    3.847832e-02f, 4.609784e-02f, 5.511953e-02f, 6.575257e-02f,
    7.822113e-02f, 9.276013e-02f, 1.096090e-01f, 1.290077e-01f,
    1.512047e-01f, 1.764441e-01f, 2.049517e-01f, 2.369246e-01f,
    2.725123e-01f, 3.117820e-01f, 3.547064e-01f, 4.011473e-01f,
    4.508369e-01f, 5.034164e-01f, 5.586361e-01f, 6.162734e-01f,
    6.760982e-01f, 7.378822e-01f, 8.013019e-01f, 8.655573e-01f,
    9.295791e-01f, 9.921293e-01f, 1.051821e+00f, 1.107509e+00f,
    1.159527e+00f, 1.208869e+00f, 1.256834e+00f, 1.305008e+00f,
    1.354758e+00f, 1.405594e+00f, 1.456414e+00f, 1.505960e+00f,
    1.552826e+00f, 1.595902e+00f, 1.635768e+00f, 1.673573e+00f,
    1.710604e+00f, 1.748280e+00f, 1.787504e+00f, 1.826609e+00f,
    1.863108e+00f, 1.894332e+00f, 1.917479e+00f, 1.930529e+00f,
    1.934819e+00f, 1.932650e+00f, 1.926395e+00f, 1.918437e+00f,
    1.910430e+00f, 1.901224e+00f, 1.889000e+00f, 1.871996e+00f,
    1.848545e+00f, 1.817792e+00f, 1.781627e+00f, 1.742514e+00f,
    1.702749e+00f, 1.664439e+00f, 1.629207e+00f, 1.597360e+00f,
    1.568896e+00f, 1.543823e+00f, 1.522157e+00f, 1.503611e+00f,
    1.486673e+00f, 1.469595e+00f, 1.450709e+00f, 1.428440e+00f,
    1.401587e+00f, 1.370094e+00f, 1.334220e+00f, 1.294275e+00f,
    1.250610e+00f, 1.203696e+00f, 1.154316e+00f, 1.103284e+00f,
    1.051347e+00f, 9.991789e-01f, 9.473958e-01f, 8.966222e-01f,
    8.473981e-01f, 8.001576e-01f, 7.552379e-01f, 7.127879e-01f,
    6.725198e-01f, 6.340976e-01f, 5.972433e-01f, 5.617313e-01f,
    5.274921e-01f, 4.948809e-01f, 4.642586e-01f, 4.358841e-01f,
    4.099313e-01f, 3.864261e-01f, 3.650566e-01f, 3.454812e-01f,
    3.274095e-01f, 3.105939e-01f, 2.948102e-01f, 2.798194e-01f,
    2.654100e-01f, 2.514084e-01f, 2.376753e-01f, 2.241211e-01f,
    2.107484e-01f, 1.975839e-01f, 1.846574e-01f, 1.720018e-01f,
    1.596918e-01f, 1.479415e-01f, 1.369428e-01f, 1.268279e-01f,
    1.176796e-01f, 1.094970e-01f, 1.020943e-01f, 9.527993e-02f,
    8.890075e-02f, 8.283548e-02f, 7.700982e-02f, 7.144001e-02f,
    6.615436e-02f, 6.117199e-02f, 5.650407e-02f, 5.215121e-02f,
    4.809566e-02f, 4.431720e-02f, 4.079734e-02f, 3.751912e-02f,
    3.446846e-02f, 3.163764e-02f, 2.901901e-02f, 2.660364e-02f,
    2.438164e-02f, 2.234097e-02f, 2.046415e-02f, 1.873456e-02f,
    1.713788e-02f, 1.566174e-02f, 1.429644e-02f, 1.303702e-02f,
    1.187897e-02f, 1.081725e-02f, 9.846470e-03f, 8.960687e-03f,
    8.152811e-03f, 7.416025e-03f, 6.744115e-03f, 6.131421e-03f,
    5.572778e-03f, 5.063463e-03f, 4.599169e-03f, 4.175971e-03f,
    3.790291e-03f, 3.438952e-03f, 3.119341e-03f, 2.829038e-03f,
    2.565722e-03f, 2.327186e-03f, 2.111280e-03f, 1.915766e-03f,
    1.738589e-03f, 1.577920e-03f, 1.432128e-03f, 1.299781e-03f,
    1.179667e-03f, 1.070694e-03f, 9.718623e-04f, 8.822531e-04f,
    8.010231e-04f, 7.273884e-04f, 6.606347e-04f, 6.001146e-04f,
    5.452416e-04f, 4.954847e-04f, 4.503642e-04f, 4.094455e-04f,
    3.723345e-04f, 3.386739e-04f, 3.081396e-04f, 2.804370e-04f,
    2.552996e-04f, 2.324859e-04f, 2.117772e-04f, 1.929758e-04f,
    1.759024e-04f, 1.603947e-04f, 1.463059e-04f, 1.335031e-04f,
    1.218660e-04f, 1.112857e-04f, 1.016634e-04f, 9.291003e-05f,
    8.494468e-05f, 7.769425e-05f, 7.109247e-05f, 6.507936e-05f,
    5.960061e-05f, 5.460706e-05f, 5.005417e-05f, 4.590157e-05f,
    4.211268e-05f, 3.865437e-05f, 3.549661e-05f, 3.261220e-05f,
    2.997643e-05f, 2.756693e-05f, 2.536339e-05f, 2.334738e-05f,
    2.150221e-05f, 1.981268e-05f, 1.826500e-05f, 1.684667e-05f,
    1.554631e-05f, 1.435360e-05f, 1.325915e-05f, 1.225443e-05f,
    1.133169e-05f, 1.048387e-05f, 0.000000e+00f, 0.000000e+00f,
    0.000000e+00f, 0.000000e+00f, 0.000000e+00f, 0.000000e+00f,
    0.000000e+00f, 0.000000e+00f, 0.000000e+00f, 0.000000e+00f,
    0.000000e+00f, 0.000000e+00f, 0.000000e+00f, 0.000000e+00f,
    0.000000e+00f, 0.000000e+00f, 0.000000e+00f, 0.000000e+00f,
    0.000000e+00f, 0.000000e+00f, 0.000000e+00f, 0.000000e+00f,
    0.000000e+00f, 0.000000e+00f, 0.000000e+00f, 0.000000e+00f,
    0.000000e+00f, 0.000000e+00f, 0.000000e+00f, 0.000000e+00f,
    0.000000e+00f, 0.000000e+00f, 0.000000e+00f, 0.000000e+00f,
    0.000000e+00f, 0.000000e+00f, 0.000000e+00f, 0.000000e+00f,
    0.000000e+00f, 0.000000e+00f, 0.000000e+00f, 0.000000e+00f,
    0.000000e+00f, 0.000000e+00f, 0.000000e+00f, 0.000000e+00f,
    0.000000e+00f, 0.000000e+00f, 0.000000e+00f, 0.000000e+00f,
    0.000000e+00f, 0.000000e+00f, 0.000000e+00f, 0.000000e+00f,
    0.000000e+00f, 0.000000e+00f, 0.000000e+00f, 0.000000e+00f,
    0.000000e+00f, 0.000000e+00f, 0.000000e+00f, 0.000000e+00f,
    0.000000e+00f, 0.000000e+00f, 0.000000e+00f, 0.000000e+00f,
    0.000000e+00f, 0.000000e+00f, 0.000000e+00f, 0.000000e+00f,
    0.000000e+00f, 0.000000e+00f, 0.000000e+00f, 0.000000e+00f,
    0.000000e+00f, 0.000000e+00f, 0.000000e+00f, 0.000000e+00f,
    0.000000e+00f, 0.000000e+00f, 0.000000e+00f, 0.000000e+00f,
    0.000000e+00f, 0.000000e+00f, 0.000000e+00f, 0.000000e+00f,
    0.000000e+00f, 0.000000e+00f, 0.000000e+00f, 0.000000e+00f,
    0.000000e+00f, 0.000000e+00f, 0.000000e+00f, 0.000000e+00f,
    0.000000e+00f, 0.000000e+00f, 0.000000e+00f, 0.000000e+00f,
    0.000000e+00f, 0.000000e+00f, 0.000000e+00f, 0.000000e+00f,
    0.000000e+00f, 0.000000e+00f, 0.000000e+00f, 0.000000e+00f,
    0.000000e+00f, 0.000000e+00f, 0.000000e+00f, 0.000000e+00f,
    0.000000e+00f, 0.000000e+00f, 0.000000e+00f, 0.000000e+00f,
    0.000000e+00f, 0.000000e+00f, 0.000000e+00f, 0.000000e+00f,
    0.000000e+00f, 0.000000e+00f, 0.000000e+00f, 0.000000e+00f,
    0.000000e+00f, 0.000000e+00f, 0.000000e+00f, 0.000000e+00f,
    0.000000e+00f, 0.000000e+00f, 0.000000e+00f, 0.000000e+00f,
    0.000000e+00f, 0.000000e+00f, 0.000000e+00f, 0.000000e+00f,
    0.000000e+00f, 0.000000e+00f, 0.000000e+00f, 0.000000e+00f,
    0.000000e+00f, 0.000000e+00f, 0.000000e+00f, 0.000000e+00f,
    0.000000e+00f, 0.000000e+00f, 0.000000e+00f, 0.000000e+00f,
    0.000000e+00f, 0.000000e+00f, 0.000000e+00f, 0.000000e+00f,
    0.000000e+00f, 0.000000e+00f, 0.000000e+00f, 0.000000e+00f,
    0.000000e+00f, 0.000000e+00f, 0.000000e+00f, 0.000000e+00f,
    0.000000e+00f, 0.000000e+00f, 0.000000e+00f, 0.000000e+00f,
    0.000000e+00f, 0.000000e+00f, 0.000000e+00f, 0.000000e+00f,
    0.000000e+00f, 0.000000e+00f, 0.000000e+00f, 0.000000e+00f,
    0.000000e+00f, 0.000000e+00f, 0.000000e+00f, 0.000000e+00f,
    0.000000e+00f, 0.000000e+00f, 0.000000e+00f, 0.000000e+00f,
    0.000000e+00f, 0.000000e+00f, 0.000000e+00f, 0.000000e+00f,
    0.000000e+00f, 0.000000e+00f, 0.000000e+00f, 0.000000e+00f,
    0.000000e+00f, 0.000000e+00f, 0.000000e+00f, 0.000000e+00f,
    0.000000e+00f, 0.000000e+00f, 0.000000e+00f, 0.000000e+00f,
    0.000000e+00f, 0.000000e+00f, 0.000000e+00f, 0.000000e+00f,
    0.000000e+00f, 0.000000e+00f, 0.000000e+00f, 0.000000e+00f,
    0.000000e+00f, 0.000000e+00f, 0.000000e+00f, 0.000000e+00f,
    0.000000e+00f, 0.000000e+00f, 0.000000e+00f, 0.000000e+00f,
    0.000000e+00f, 0.000000e+00f, 0.000000e+00f, 0.000000e+00f,
    0.000000e+00f
};

float SpectralMapper::CIE_D65[D65WavelengthSize] = {
    0.000341f, 0.016643f, 0.032945f, 0.117652f,
    0.20236f, 0.286447f, 0.370535f, 0.385011f,
    0.399488f, 0.424302f, 0.449117f, 0.45775f,
    0.466383f, 0.493637f, 0.520891f, 0.510323f,
    0.499755f, 0.523118f, 0.546482f, 0.687015f,
    0.827549f, 0.871204f, 0.91486f, 0.924589f,
    0.934318f, 0.90057f, 0.866823f, 0.957736f,
    1.04865f, 1.10936f, 1.17008f, 1.1741f,
    1.17812f, 1.16336f, 1.14861f, 1.15392f,
    1.15923f, 1.12367f, 1.08811f, 1.09082f,
    1.09354f, 1.08578f, 1.07802f, 1.06296f,
    1.0479f, 1.06239f, 1.07689f, 1.06047f,
    1.04405f, 1.04225f, 1.04046f, 1.02023f,
    1.0f, 0.981671f, 0.963342f, 0.960611f,
    0.95788f, 0.922368f, 0.886856f, 0.893459f,
    0.900062f, 0.898026f, 0.895991f, 0.886489f,
    0.876987f, 0.854936f, 0.832886f, 0.834939f,
    0.836992f, 0.81863f, 0.800268f, 0.801207f,
    0.802146f, 0.812462f, 0.822778f, 0.80281f,
    0.782842f, 0.740027f, 0.697213f, 0.706652f,
    0.716091f, 0.72979f, 0.74349f, 0.679765f,
    0.61604f, 0.657448f, 0.698856f, 0.724863f,
    0.75087f, 0.693398f, 0.635927f, 0.550054f,
    0.464182f, 0.566118f, 0.668054f, 0.650941f,
    0.633828f, 0.638434f, 0.64304f, 0.618779f,
    0.594519f, 0.557054f, 0.51959f, 0.546998f,
    0.574406f, 0.588765f, 0.603125f
};

float SpectralMapper::computeNormFactorD65()
{
    std::set<float> wavelengths;
    for (size_t i = 0; i < CIEWavelengthSize; ++i) {
        float wvl = (CIEWavelengthEnd - CIEWavelengthStart) * i / (CIEWavelengthSize - 1) + CIEWavelengthStart;
        wavelengths.insert(wvl);
    }

    for (size_t i = 0; i < D65WavelengthSize; ++i) {
        float wvl = (D65WavelengthEnd - D65WavelengthStart) * i / (D65WavelengthSize - 1) + D65WavelengthStart;
        if (wvl >= CIEWavelengthStart && wvl <= CIEWavelengthEnd)
            wavelengths.insert(wvl);
    }

    float trapz = 0;
    for (auto it = wavelengths.begin(); it != wavelengths.end(); ++it) {
        auto nit = it;
        std::advance(nit, 1);
        if (nit == wavelengths.end())
            break;

        float wa = *it;
        float wb = *nit;

        float aY = lookup(wa, CIE_Y, CIEWavelengthStart, CIEWavelengthEnd, CIEWavelengthSize);
        float aI = lookupD65(wa);
        float bY = lookup(wb, CIE_Y, CIEWavelengthStart, CIEWavelengthEnd, CIEWavelengthSize);
        float bI = lookupD65(wb);

        float a  = aI * aY;
        float b  = bI * bY;
        float dx = wb - wa;
        trapz += dx * (b + a) / 2;
    }

    return trapz;
}

float SpectralMapper::CIEYNormD65 = SpectralMapper::computeNormFactorD65();